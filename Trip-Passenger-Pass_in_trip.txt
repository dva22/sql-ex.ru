/***
Схема БД состоит из четырех отношений:
Company (ID_comp, name)
Trip(trip_no, ID_comp, plane, town_from, town_to, time_out, time_in)
Passenger(ID_psg, name)
Pass_in_trip(trip_no, date, ID_psg, place)
Таблица Company содержит идентификатор и название компании, осуществляющей перевозку пассажиров. Таблица Trip содержит информацию о рейсах: номер рейса, идентификатор компании, тип самолета, город отправления, город прибытия, время отправления и время прибытия. Таблица Passenger содержит идентификатор и имя пассажира. Таблица Pass_in_trip содержит информацию о полетах: номер рейса, дата вылета (день), идентификатор пассажира и место, на котором он сидел во время полета. При этом следует иметь в виду, что
- рейсы выполняются ежедневно, а длительность полета любого рейса менее суток; town_from <> town_to;
- время и дата учитывается относительно одного часового пояса;
- время отправления и прибытия указывается с точностью до минуты;
- среди пассажиров могут быть однофамильцы (одинаковые значения поля name, например, Bruce Willis);
- номер места в салоне – это число с буквой; число определяет номер ряда, буква (a – d) – место в ряду слева направо в алфавитном порядке;
- связи и ограничения показаны на схеме данных.***/

/***
Задание: 76 (Serge I: 2003-08-28)
Определить время, проведенное в полетах, для пассажиров, летавших всегда на разных местах. Вывод: имя пассажира, время в минутах.

WITH dsPsg AS
(SELECT pt.Id_psg id
FROM Pass_in_trip pt, Trip t
WHERE t.trip_no = pt.trip_no 
GROUP BY pt.Id_psg
HAVING COUNT(DISTINCT pt.place) = COUNT(pt.place)
),
dsTime AS
(SELECT pt.Id_psg id, 
        sum(DATEDIFF(minute, time_out, DATEADD(DAY,IIF(time_in<time_out,1,0)
                     ,time_in))
           ) dur 
 FROM Pass_in_trip pt, Trip t
 WHERE t.trip_no = pt.trip_no 
 GROUP BY pt.Id_psg
)
SELECT p.name, dsTime.dur
FROM dsPsg, Passenger p, dsTime
WHERE p.ID_psg = dsPsg.id and
      dsTime.id = p.ID_psg

Задание: 88 (Serge I: 2003-04-29)
Среди тех, кто пользуется услугами только одной компании, определить имена разных пассажиров, летавших чаще других. 
Вывести: имя пассажира, число полетов и название компании.
WITH dsPsg AS
(SELECT p.ID_psg,
        COUNT(DISTINCT t.ID_comp) countComp,
        COUNT(*) trip_Qty,
        max(t.ID_comp) idComp
 FROM Trip t, Pass_in_trip p
 WHERE p.trip_no = t.trip_no
 GROUP BY p.ID_psg
 HAVING COUNT(DISTINCT t.ID_comp) = 1
)
SELECT p.name, dsPsg.trip_Qty, c.name
FROM dsPsg, Company c, Passenger p
WHERE dsPsg.ID_psg = p.ID_psg and
      dsPsg.idComp = c.ID_Comp and
      dsPsg.trip_Qty = (SELECT max(dsPsg.trip_Qty)
                        FROM dsPsg
                       )

Задание: 87 (Serge I: 2003-08-28)
Считая, что пункт самого первого вылета пассажира является местом жительства, найти не москвичей, которые прилетали в Москву более одного раза. 
Вывод: имя пассажира, количество полетов в Москву
WITH dsFirst AS
(SELECT p.ID_psg, min(date + time_out) date
 FROM Pass_in_trip p, Trip t
 WHERE t.trip_no = p.trip_no
 GROUP BY p.ID_psg
),
dsFirstM AS
(SELECT p.ID_psg
FROM dsFirst, Pass_in_trip p, Trip t
WHERE dsFirst.date = (p.date + time_out) and 
      dsFirst.ID_psg = p.ID_psg and 
      t.trip_no = p.trip_no and
      t.town_from = 'Moscow'
),
dsComeM AS
(SELECT p.ID_psg, COUNT(*) count
 FROM Pass_in_trip p, Trip t
 WHERE t.trip_no = p.trip_no and
      t.town_to = 'Moscow'
 GROUP BY p.ID_psg
 HAVING COUNT(*) > 1
)
SELECT p.name, dsComeM.count
FROM dsComeM, Passenger p
WHERE p.ID_psg = dsComeM.ID_psg and
      dsComeM.ID_psg not in (SELECT dsFirstM.ID_psg
                             FROM dsFirstM 
                            )
Задание: 94 (Serge I: 2003-04-09)
Для семи последовательных дней, начиная от минимальной даты, когда из Ростова было совершено максимальное число рейсов, определить число рейсов из Ростова. 
Вывод: дата, количество рейсов
WITH dsMax AS 
(SELECT p.date
 FROM Trip t, Pass_in_trip p 
 WHERE t.trip_no = p.trip_no and
       t.town_from = 'Rostov'
 GROUP BY p.date
HAVING count(DISTINCT p.trip_no) = (SELECT TOP 1 count(DISTINCT p.trip_no)
                                      FROM Trip t, Pass_in_trip p 
                                      WHERE t.trip_no = p.trip_no and
                                            t.town_from = 'Rostov'
                                      GROUP BY p.date
                                     ORDER BY count(DISTINCT p.trip_no) DESC
                                     )
),
dsDates AS 
(SELECT DATEADD(day, 0, (SELECT min(date)
                         FROM dsMax)) date1
 UNION
 SELECT DATEADD(day, 1, (SELECT min(date)
                         FROM dsMax)) 
 UNION
 SELECT DATEADD(day, 2, (SELECT min(date)
                         FROM dsMax)) 
 UNION
 SELECT DATEADD(day, 3, (SELECT min(date)
                         FROM dsMax)) 
 UNION
 SELECT DATEADD(day, 4, (SELECT min(date)
                         FROM dsMax))
 UNION
 SELECT DATEADD(day, 5, (SELECT min(date)
                         FROM dsMax))
 UNION
 SELECT DATEADD(day, 6, (SELECT min(date)
                         FROM dsMax))
),
dsRostov AS
(SELECT p.date , count(DISTINCT p.trip_no) count
 FROM Pass_in_trip p,
      Trip t
 WHERE t.trip_no = p.trip_no and
       t.town_from = 'Rostov' 
 group by p.date
)
SELECT  dsDates.date1, COALESCE(dsRostov.count, 0)
FROM dsDates left join dsRostov on dsDates.date1 = dsRostov.date

***/
