«адание: 40 (Serge I: 2018-09-07) 
–ассматриваютс€ пункты приема вторсырь€ с отчетностью несколько раз в день.
ќпределить процент выплат каждого пункта в общем итоге за каждый день, дл€ которого есть запись в таблице Outcome.
¬ывод: день в формате "yyyy-mm-dd", проценты каждого пункта (округленные до целого) в пор€дке возрастани€ номеров пунктов через пробел.
WITH
dsS AS
(
SELECT 
    p.point,
    d.date,
    (SELECT COALESCE(SUM(out),0) 
     FROM Outcome 
     WHERE point = p.point and date = d.date) sum
FROM
   (SELECT DISTINCT point FROM Outcome UNION
    SELECT DISTINCT point FROM Income) p,
   (SELECT DISTINCT date FROM Outcome) d
),
dsP AS
(
SELECT
   point,
   date,
   CAST((sum/
         SUM(sum) OVER(PARTITION BY date)) * 100 AS int) pers
FROM
   dsS
)
SELECT
   FORMAT(date,'yyyy-MM-dd'),
   STRING_AGG(pers, ' ') WITHIN GROUP(ORDER BY point)   
FROM
   dsP
GROUP BY 
   date

«адание: -8 (Shurgenz: 2006-03-14) 
‘ирма открывает новые пункты по приему вторсырь€.
ѕри открытии, каждому из них были выданы "подъемные" в размере 20 т.р.
 аждому из пунктов была поставлена задача об увеличении первоначального капитала до 150%, с отчетностью - один раз в день. »спользу€ одну только таблицу Outcome_o и при условии, что пункты работают с двойной накруткой, то есть на каждый выплаченный сдатчику рубль они получают доход 2 рубл€, найти:
- ƒл€ пунктов, справившихс€ с заданием, определить дату его выполнени€ и сумму денежных средств, полученных сверх плана на эту дату;
- ƒл€ пунктов, которые не справились с заданием, определить на последнюю отчетную дату сумму денежных средств, недостающих до его выполнени€.
¬ывод: пункт, дата выполнени€ (или последний день), сумма сверх плана (или недостающую сумму до плана).
WITH
dsP AS
(
SELECT
   point,
   date,
   SUM(out) OVER(PARTITION BY point ORDER BY date) balance,
   MAX(date) OVER(PARTITION BY point) maxDate
FROM
   Outcome_o
),
dsP1 AS
(
SELECT
  point,
  date,
  balance - 10000 balance,
  MIN(date) OVER(PARTITION BY point) MIN
FROM
  dsP
WHERE
  balance >= 10000 OR
  date = maxDate
)
SELECT
  point,
  date,
  balance
FROM 
   dsP1
WHERE
   min = date

N 
«адание: -16 (Serge I: 2012-01-19) 
Ќайти такие пункты приема, которые имеют в таблице Outcome записи на каждый рабочий день в течение некоторой недели (календарные дни, исключа€ субботу и воскресенье).
¬ывод: номер пункта, дата понедельника полной рабочей недели в формате "YYYY-MM-DD", суммарное значение out за эту рабочую неделю.
SELECT
  o.point,
  FORMAT(o.date, 'yyyy-MM-dd'),
  (
   SELECT
     SUM(out)
   FROM
     Outcome
   WHERE 
     point = o.point AND
     date <= DATEADD(DAY, 4, o.date) AND
     date >= o.date
  )  
FROM 
  Outcome o
WHERE
  DATEPART(weekday, o.date) = 2 AND
  EXISTS (
SELECT *
FROM
  Outcome
WHERE
  point = o.point AND
  date = DATEADD(DAY, 1, o.date)
         ) AND
  EXISTS (
   SELECT
     *
   FROM
     Outcome
   WHERE 
     point = o.point AND
     date <= DATEADD(DAY, 4, o.date) AND
     date >= o.date
  HAVING COUNT(DISTINCT date) >= 5
) 
GROUP BY 
  o.point,
  o.date,
  FORMAT(o.date, 'yyyy-MM-dd')

