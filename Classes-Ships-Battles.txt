/***
Рассматривается БД кораблей, участвовавших во второй мировой войне. Имеются следующие отношения:
Classes (class, type, country, numGuns, bore, displacement)
Ships (name, class, launched)
Battles (name, date)
Outcomes (ship, battle, result) 
Корабли в «классах» построены по одному и тому же проекту, и классу присваивается либо имя первого корабля, построенного по данному проекту, либо названию класса дается имя проекта, которое не совпадает ни с одним из кораблей в БД. Корабль, давший название классу, называется головным.
Отношение Classes содержит имя класса, тип (bb для боевого (линейного) корабля или bc для боевого крейсера), страну, в которой построен корабль, число главных орудий, калибр орудий (диаметр ствола орудия в дюймах) и водоизмещение ( вес в тоннах). В отношении Ships записаны название корабля, имя его класса и год спуска на воду. В отношение Battles включены название и дата битвы, в которой участвовали корабли, а в отношении Outcomes – результат участия данного корабля в битве (потоплен-sunk, поврежден - damaged или невредим - OK). 
Замечания. 1) В отношение Outcomes могут входить корабли, отсутствующие в отношении Ships. 2) Потопленный корабль в последующих битвах участия не принимает.
***/

/***
Задание: 32 (Serge I: 2003-02-17)
Одной из характеристик корабля является половина куба калибра его главных орудий (mw). С точностью до 2 десятичных знаков определите среднее значение mw для кораблей каждой страны, у которой есть корабли в базе данных.
Select country, cast(avg((power(bore,3)/2)) as numeric(6,2)) as weight 
from (select country, classes.class, bore, name from classes , ships WHERE classes.class=ships.class 
union 
select  country, class, bore, ship from classes t1 , outcomes t2  WHERE t1.class=t2.ship  ) a 
 group by country

Задание: 47 (Serge I: 2011-02-11)
Пронумеровать строки из таблицы Product в следующем порядке: имя производителя в порядке убывания числа производимых им моделей (при одинаковом числе моделей имя производителя в алфавитном порядке по возрастанию), номер модели (по возрастанию).
Вывод: номер в соответствии с заданным порядком, имя производителя (maker), модель (model) 

SELECT ROW_NUMBER() OVER(ORDER BY models.model desc, p.maker, p.model) no,p.maker, p.model
FROM (SELECT p.maker , count(p.model) model
      FROM Product p
      GROUP BY p.maker
     ) models,
     Product p
WHERE p.maker = models.maker

Задание: 51 (Serge I: 2003-02-17)
Найдите названия кораблей, имеющих наибольшее число орудий среди всех имеющихся кораблей такого же водоизмещения (учесть корабли из таблицы Outcomes).
WITH dsShips AS
(SELECT name, class
 FROM Ships
 UNION
 SELECT ship name, ship class
 FROM Outcomes
)
SELECT s.name
FROM dsShips s, Classes c
WHERE s.class = c.class and
      c.numGuns >= ALL(SELECT c1.numGuns
                       FROM Classes c1
                       WHERE c1.class in (SELECT dsShips.class 
                                            FROM dsShips
                                         ) and
                             c.displacement = c1.displacement
                       );

Задание: 70 (Serge I: 2003-02-14)
Укажите сражения, в которых участвовало по меньшей мере три корабля одной и той же страны.
WITH dsBattles AS
(SELECT o.battle, c.country
 FROM Outcomes o, Ships s, Classes c
 WHERE o.ship = s.name and
       c.class = s.class
 UNION ALL
 SELECT o.battle, c.country
 FROM Outcomes o, Classes c
 WHERE o.ship = c.class and
      o.ship not in (SELECT name
                     FROM Ships)
)
SELECT DISTINCT battle 
FROM dsBattles
GROUP BY battle, country
HAVING count(*) >= 3

Задание: 75 (Serge I: 2009-04-17)
Для каждого корабля из таблицы Ships указать название первого по времени сражения из таблицы Battles,
в котором корабль мог бы участвовать после спуска на воду. Если год спуска на воду неизвестен, взять последнее по времени сражение.
Если нет сражения, произошедшего после спуска на воду корабля, вывести NULL вместо названия сражения.
Считать, что корабль может участвовать во всех сражениях, которые произошли в год спуска на воду корабля.
Вывод: имя корабля, год спуска на воду, название сражения

Замечание: считать, что не существует двух битв, произошедших в один и тот же день.
WITH dsB AS
(SELECT s.name, s.launched, iif(s.launched is null,max(b.date),min(b.date)) year
 FROM Ships s left join Battles b
 on s.launched <= YEAR(b.date) or s.launched is null
 GROUP BY s.name, s.launched
)
SELECT dsB.name, dsB.launched, min(iif(dsB.year=2020,NULL,b.name))
FROM dsB left join Battles b on b.date = dsB.year
GROUP BY dsB.name, dsB.launched
***/
